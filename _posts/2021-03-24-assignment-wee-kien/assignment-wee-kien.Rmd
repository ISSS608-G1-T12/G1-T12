---
title: "Investing 101: A visual and predictive guide for the rookie investor - Wee Kien"
description: |
  Existing financial data websites such as Yahoo Finance do a good job in providing historical price data and technical indicators, but the beginner investor lacks the knowledge to properly utilise and benefit from these. In addition, we have also identified several gaps in such websites.
  
  For one, these websites do not provide tools to allow the user to compare stocks meaningfully or zoom in to the statistical properties of financial returns. For example, a user is unable to conduct correlation analysis or visualize the distribution of returns. Secondly, these websites also do not provide any form of forecasting to aid in investorsâ€™ decisions.
    
  This project aims to improve on the current offering of financial data websites through, Exploratory Data Analysis, Time-Series Forecasting and also Time-Series Clustering.
  
author:
  - name: Wee Kien, Ng (Vincent)
    url: https://www.linkedin.com/in/ngweekiensg/
date: 03-24-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## 1. Overview

### 1.1 Background

Traditional financial data websites usually shy away from giving recommendations or advising users on investing decisions. While in depth studies are often conducted and used in academia or research, the outputs of these studies are often not accessible nor timely enough for the regular user. This means that these websites and their applications are limited in their use-cases. This can be due to issues arising from financial or legal liability if users act on the recommendations coming from these financial websites. As such we feel that this a gap between what is available publicly and user requirements. 

### 1.2 Objective and Motivation

TO BE ADDED

To talk about what other modules will focus on.

What we are doing in this particular module.

- Charting and technical analysis
- Correlation analysis between selected portfolio of stocks vs a benchmark index
- Portfolio analysis:
  - Individual portfolio returns
  - Equity curve/ portfolio growth over time


### 1.3 Charting and Technical Analysis

In this module, users are able to visualize the chosen stock symbol using a candlestick chart. Open, High, Low, and Close prices for the selected period are shown on the chart.

In addition, users are able to choose between 2 sets of technical indicators: Simple moving averages and Bollinger Bands.

Users are able to see the chosen symbol on 1 chart, and the accompanying benchmark index chosen on another chart.

Both charts are created in an interactive manner using the plotly package.

Moving Averages:

- XXX
- XXX

Bollinger Bands:

- XXX
- XXX


### 1.4 Correlation Analysis

In this module, users are able to:

- Choose 4 stock symbols and visualize their monthly adjusted prices
- Visualize any anomalous points for these 4 stock symbols using an interactive chart
- Visualize the 6 month rolling correlation between the 4 stock symbols, and the accompanying benchmark index


### 1.5 Portfolio Analysis

In this module, users are able to:

- Create 3 portfolios with different weightages for the 4 chosen stock symbols plus the accompanying benchmark index
- Visualize the monthly returns (in %) for the 3 different portfolios on an interactive plot
- Visualize an equity curve of the 3 portfolios, where users are able to choose the starting equity amount


## 2. Proposed Visualization

### 2.1 Sketch of Proposed Visualization

TO INSERT SKETCH HERE, can be multiple pictures.
Can take from powerpoint slide.


### 2.2 Suggested Interactivity in the Proposed Visualization

TO DESCRIBE in words, the various portions of the interactivity.


## 3. Building the Visualization

### 3.1 Setting up the environment/ packages

First, we run this first line of code to clear the environment and remove existing R objects (if any)

```{r, echo=TRUE, eval=TRUE, fig.cap="Starting on a clean slate"}

rm(list=ls())

```

This code chunk checks if required packages are installed. If they are not installed, the next line of code will install them. The following line is then use to import the library into the current working environment.

```{r, echo=TRUE, eval=TRUE, fig.cap="Installing and importing libraries"}

packages = c('tidyverse','tidyquant','dygraphs','plotly','ggplot2','timetk')
for (p in packages) {
  if(!require(p,character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}

```

### 3.2 Charting and Technical Analysis

Users will be able to specify the start and end dates for the period under analysis. In addition, they are able to specify the periodicity (e.g. days, weeks, months, years).

```{r, echo=TRUE, eval=TRUE, fig.cap="Setting the start and end dates of the period under analysis"}
from_date <- "2016-01-01"
to_date <- "2019-12-31"
period_type <- "days"
# "days"/ "weeks"/ "months"/ "years"
```

Users are able to select the individual stock symbol and benchmark index of their choice. The following code chunk utilizes the tidyquant package to extract stock data from Yahoo Finance. Depending on the period_type specified by users before, the periodicity can be changed.

```{r, echo=TRUE, eval=TRUE, fig.cap="Extracting stock data based on user input symbols"}
ticker_selected <- "AAPL" 

ticker_data_daily <- tq_get(ticker_selected,
               get = "stock.prices",
               from = from_date,
               to = to_date) %>%
            tq_transmute(select     = NULL, 
                 mutate_fun = to.period, 
                 period     = period_type)
ticker_data_daily 

# Benchmark Index
benchmark_selected <- "XLK"

benchmark_data_daily <- tq_get(benchmark_selected,
               get = "stock.prices",
               from = from_date,
               to = to_date) %>%
              tq_transmute(select     = NULL, 
                 mutate_fun = to.period, 
                 period     = period_type)
benchmark_data_daily
```

The following code chunk creates a clean candlestick chart without indicators for the selected stock ticker and benchmark index. To use the dygraphs package, the input data has to be transformed from tibble to xts (extensible time series) format. We use the tk_xts() function from the timetk package for this.

For charting, we use the dygraph package. We specify dyCandlestick() to create a candlestick chart, and dyRangeSelector() to allow users to have the ability to toggle the range on the charts. In addition, specifying the group = "charting" argument allows for synchronization between charts sharing the same argument value. Changes made to either affects both charts interactively.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Normal graphs without indicators"}
ticker_data_daily_xts <- tk_xts(
  ticker_data_daily %>%  select(date, open,high,low,close) )

ticker_data_daily_xts %>%
  dygraph(main = "Candlestick Chart for AAPL", group = "charting") %>% 
    dyCandlestick() %>%
    dyRangeSelector() 

benchmark_data_daily_xts <- tk_xts(
  benchmark_data_daily %>%  select(date, open,high,low,close) )

benchmark_data_daily_xts %>%
  dygraph(main = "Candlestick Chart for Benchmark Index (XLK)", group = "charting") %>% 
    dyCandlestick() %>% 
    dyRangeSelector()
```

The following code chunk creates a similar candlestick chart, this time with the simple moving averages technical indicator.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Candlestick graphs with simple moving average indicators"}
# 20-day SMA
sma_fast <- SMA(ticker_data_daily_xts$close, n=20)
# 40-day SMA
sma_med <- SMA(ticker_data_daily_xts$close, n=40)
# 200-day SMA
sma_slow <- SMA(ticker_data_daily_xts$close, n=200)

ticker_data_daily_xts_sma <- data.frame(ticker_data_daily_xts, sma_fast, sma_med, sma_slow)

# head(ticker_data_daily_xts_sma)

chart_sma <- cbind(ticker_data_daily_xts_sma[,1:4], ticker_data_daily_xts_sma[,5], ticker_data_daily_xts_sma[,6], ticker_data_daily_xts_sma[,7])
colnames(chart_sma)[5]  <- "Fast SMA"
colnames(chart_sma)[6]  <- "Medium SMA"
colnames(chart_sma)[7]  <- "Slow SMA"

chart_sma %>%
  dygraph(main = "Candlestick Chart for AAPL - Simple Moving Averages", group = "chart_sma") %>% 
    dyCandlestick() %>% 
    dyRangeSelector()

# 20-day SMA
sma_fast_bm <- SMA(benchmark_data_daily_xts$close, n=20)
# 40-day SMA
sma_med_bm <- SMA(benchmark_data_daily_xts$close, n=40)
# 200-day SMA
sma_slow_bm <- SMA(benchmark_data_daily_xts$close, n=200)

benchmark_data_daily_xts_sma <- data.frame(benchmark_data_daily_xts, sma_fast_bm, sma_med_bm, sma_slow_bm)

# head(benchmark_data_daily_xts_sma)

chart_sma_bm <- cbind(benchmark_data_daily_xts_sma[,1:4], benchmark_data_daily_xts_sma[,5], benchmark_data_daily_xts_sma[,6], benchmark_data_daily_xts_sma[,7])
colnames(chart_sma_bm)[5]  <- "Fast SMA"
colnames(chart_sma_bm)[6]  <- "Medium SMA"
colnames(chart_sma_bm)[7]  <- "Slow SMA"

chart_sma_bm %>%
  dygraph(main = "Candlestick Chart for Benchmark (XLK) - Simple Moving Averages", group = "chart_sma") %>% 
    dyCandlestick() %>% 
    dyRangeSelector()
```

The following code chunk creates a similar candlestick chart, this time with the Bollinger Bands technical indicator.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Candlestick graphs with bollinger bands indicators"}
bb20 <- BBands(ticker_data_daily_xts$close, sd=2.0, n=14, maType=EMA)

ticker_data_daily_xts_bb <- data.frame(ticker_data_daily_xts, bb20)

chart_bband <- cbind(ticker_data_daily_xts_bb[,1:4], ticker_data_daily_xts_bb[,5], ticker_data_daily_xts_bb[,6], ticker_data_daily_xts_bb[,7])
colnames(chart_bband)[5]  <- "Lower Band"
colnames(chart_bband)[6]  <- "Moving Average"
colnames(chart_bband)[7]  <- "Upper Band"

chart_bband %>%
  dygraph(main = "Candlestick Chart for AAPL - Bollinger Bands", group = "chart_bband") %>% 
    dyCandlestick() %>% 
    dyRangeSelector()


bb20_bm <- BBands(benchmark_data_daily_xts$close, sd=2.0, n=14, maType=EMA)

benchmark_data_daily_xts_bb <- data.frame(benchmark_data_daily_xts, bb20_bm)

chart_bband_bm <- cbind(benchmark_data_daily_xts_bb[,1:4], benchmark_data_daily_xts_bb[,5], benchmark_data_daily_xts_bb[,6], benchmark_data_daily_xts_bb[,7])
colnames(chart_bband_bm)[5]  <- "Lower Band"
colnames(chart_bband_bm)[6]  <- "Moving Average"
colnames(chart_bband_bm)[7]  <- "Upper Band"

chart_bband_bm %>%
  dygraph(main = "Candlestick Chart for Benchmark (XLK) - Bollinger Bands", group = "chart_bband") %>% 
    dyCandlestick() %>% 
    dyRangeSelector()

```

### 3.3 Correlation Analysis

Similar to the previous module, users will be able to specify the start and end dates for the period under analysis. In addition, they are able to specify the periodicity (e.g. days, weeks, months, years).

```{r, echo=TRUE, eval=TRUE, fig.cap="Setting the start and end dates of the period under analysis"}
from_date <- "2016-01-01"
to_date <- "2019-12-31"
period_type <- "days"
# "days"/ "weeks"/ "months"/ "years"
```

In the following code chunk, users select 4 stock symbols to form a portfolio, and an accompanying underlying benchmark index symbol. Data extracted is based on adjusted prices. For the purposes of measuring returns, a monthly periodicity is selected to avoid noise in the short term (e.g. daily).

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Extracting data for a selected portfolio of stocks"}
port_corr_ticker_selection <- c("TSLA", "AAPL", "GOOG", "NFLX")
port_corr_benchmark_ticker <- "XLK"

PORT_mth <- port_corr_ticker_selection %>%
    tq_get(get  = "stock.prices",
           from = from_date,
           to   = to_date) %>%
    group_by(symbol) %>%
    tq_transmute(select     = adjusted, 
                 mutate_fun = to.period, 
                 period     = "months")
head(PORT_mth)

```

In the following code chunk, users are able to visualize the monthly stock prices for the 4 chosen stocks in a facet wrap for convenience. The plots are made interactive using the plotly package.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Visualizing monthly stock prices for the portfolio of stocks"}

port_mth_plotly <- PORT_mth %>%
        ggplot(aes(x = date, y = adjusted, color = symbol)) +
        geom_line(size = 1) +
        labs(title = "Monthly Stock Prices",
             x = "", y = "", color = "") +
        facet_wrap(~ symbol, ncol = 2, scales = "free_y") +
        scale_y_continuous(labels = scales::dollar) +
        theme_tq() + 
        scale_color_tq()
port_mth_plotly <- ggplotly(port_mth_plotly) %>% 
        layout(yaxis = list(title = list(text = "Adjusted Prices", standoff = 20L)))
port_mth_plotly

```

In the following code chunk, users are able to visualize anomalous points in the monthly stock prices for the 4 chosen stocks in a facet wrap for convenience. The plots are made interactive using the plotly package. While stocks in general may exhibit a volatile nature, such anomalous points in time may provide some indication of a turning point where stocks have been overbought or oversold in the short term.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Visualizing anomaly diagnostics points for the 4 stocks"}

PORT_mth %>%
    group_by(symbol) %>%
    plot_anomaly_diagnostics(date, adjusted, .facet_ncol = 2) %>% 
    layout(yaxis = list(title = list(text = "Adjusted Prices", standoff = 20L)))

```

In the following code chunk, the monthly returns are calculated for both the selected portfolio stocks and the accompanying benchmark index.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Calculating monthly returns for portfolio stocks and benchmark index"}

PORT_returns_monthly <- port_corr_ticker_selection %>%
    tq_get(get  = "stock.prices",
           from = from_date,
           to   = to_date) %>%
    group_by(symbol) %>%
    tq_transmute(select     = adjusted, 
                 mutate_fun = periodReturn, 
                 period     = "monthly")

head(PORT_returns_monthly)

# Baseline Returns
baseline_returns_monthly <- port_corr_benchmark_ticker %>%
    tq_get(get  = "stock.prices",
           from = from_date,
           to   = to_date) %>%
    tq_transmute(select     = adjusted, 
                 mutate_fun = periodReturn,
                 period     = "monthly")

```

In the following code chunk, a left join is performed to combine the monthly returns of the portfolio and the benchmark index returns.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Performing a left join to bring in the baseline benchmark returns"}

returns_joined <- left_join(PORT_returns_monthly, 
                            baseline_returns_monthly,
                            by = "date")
head(returns_joined)

```

In the following code chunk, the runCor function is used to evaluate the rolling correlations using the xy pattern.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Rolling correlations between portfolio stocks and benchmark is calculated"}

PORT_rolling_corr <- returns_joined %>%
    tq_transmute_xy(x          = monthly.returns.x, 
                    y          = monthly.returns.y,
                    mutate_fun = runCor,
                    n          = 6,
                    col_rename = "rolling.corr.6")
tail(PORT_rolling_corr)
```

In the following code chunk, the rolling correlations previously calculated are not visualized using plotly.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Rolling correlations are visualized"}

port_rolling_corr_plotly <- PORT_rolling_corr %>%
        ggplot(aes(x = date, y = rolling.corr.6, color = symbol)) +
        geom_hline(yintercept = 0, color = palette_light()[[1]]) +
        geom_line(size = 1) +
        labs(title = "Portfolio of selected stocks: Six Month Rolling Correlation to XLK",
             x = "", y = "", color = "") +
        facet_wrap(~ symbol, ncol = 2) +
        theme_tq() + 
        scale_color_tq()

port_rolling_corr_plotly <- ggplotly(port_rolling_corr_plotly) %>% 
        layout(yaxis = list(title = list(text = "Rolling Correlation", standoff = 20L)))
port_rolling_corr_plotly
```

### 3.4 Portfolio Analysis

Similar to the previous module, users will be able to specify the start and end dates for the period under analysis. In addition, they specify which the stock symbols for 4 stocks + 1 benchmark index. These stocks symbols will be used to form the portfolio for further analysis.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Setting the start and end dates, selecting stock symbols"}
from_date <- "2016-01-01"
to_date <- "2019-12-31"
portfolio_ticker_selection <- c("AAPL", "GOOG", "NFLX", "TSLA", "XLK")
benchmark_ticker_selection <- "XLK"
initial_investment_capital <- 10000
```

In the following code chunk, we calculate the monthly returns for the selected stock symbols.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Calculating monthly returns for the selected stock symbols"}
stock_returns_monthly <- portfolio_ticker_selection %>%
    tq_get(get  = "stock.prices",
           from = from_date,
           to   = to_date) %>%
    group_by(symbol) %>%
    tq_transmute(select     = adjusted, 
                 mutate_fun = periodReturn, 
                 period     = "monthly", 
                 col_rename = "Ra")
head(stock_returns_monthly)
```

In the following code chunk, we specify the weights of portfolio 1, and visualize the monthly returns using plotly. We create a new field called gain_loss, where gains are visualized as green, while losses are visualized as red. 

We further add a smoothing line (in blue) as an additional layer onto our graph. This allows us to quickly see a general trend of the portfolio across the period. 

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Visualization the monthly returns of Portfolio 1"}
wts_1 <- c(0.25, 0.25, 0.25, 0.25, 0.00)
portfolio_returns_monthly_1 <- stock_returns_monthly %>%
    tq_portfolio(assets_col  = symbol, 
                 returns_col = Ra, 
                 weights     = wts_1, 
                 col_rename  = "Ra") %>% 
    mutate(gain_loss = if_else(Ra > 0, "gain", "loss"))

portfolio_returns_monthly_1

port_returns_1_plotly <- portfolio_returns_monthly_1 %>%
    ggplot(aes(x = date, y = Ra)) +
    geom_bar(stat = "identity", aes(fill = gain_loss)) +
    scale_fill_manual("legend", values = c("gain" = "green4", "loss" = "red")) +
    labs(title = "Portfolio Returns 1",
         x = "", y = "Monthly Returns") +
    geom_smooth(method = "lm") +
    theme_tq() +
    scale_color_tq() +
    scale_y_continuous(labels = scales::percent)

port_returns_1_plotly <- ggplotly(port_returns_1_plotly)
port_returns_1_plotly

```

Similarly, we specify weights for the 2nd portfolio and do create a visualization in the same style.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Visualization the monthly returns of Portfolio 2"}
wts_2 <- c(0.40, 0.30, 0.20, 0.10, 0.00)
portfolio_returns_monthly_2 <- stock_returns_monthly %>%
    tq_portfolio(assets_col  = symbol, 
                 returns_col = Ra, 
                 weights     = wts_2, 
                 col_rename  = "Ra") %>% 
    mutate(gain_loss = if_else(Ra > 0, "gain", "loss"))

port_returns_2_plotly <- portfolio_returns_monthly_2 %>%
    ggplot(aes(x = date, y = Ra)) +
    geom_bar(stat = "identity", aes(fill = gain_loss)) +
    scale_fill_manual("legend", values = c("gain" = "green4", "loss" = "red")) +
    labs(title = "Portfolio Returns 2",
         x = "", y = "Monthly Returns") +
    geom_smooth(method = "lm") +
    theme_tq() +
    scale_color_tq() +
    scale_y_continuous(labels = scales::percent)
port_returns_2_plotly <- ggplotly(port_returns_2_plotly)
port_returns_2_plotly

```

Similarly, we specify weights for the 3rd portfolio and do create a visualization in the same style.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Visualization the monthly returns of Portfolio 3"}
wts_3 <- c(0.20, 0.20, 0.20, 0.20, 0.20)
portfolio_returns_monthly_3 <- stock_returns_monthly %>%
    tq_portfolio(assets_col  = symbol, 
                 returns_col = Ra, 
                 weights     = wts_3, 
                 col_rename  = "Ra")%>% 
    mutate(gain_loss = if_else(Ra > 0, "gain", "loss"))

port_returns_3_plotly <- portfolio_returns_monthly_3 %>%
    ggplot(aes(x = date, y = Ra)) +
    geom_bar(stat = "identity", aes(fill = gain_loss)) +
    scale_fill_manual("legend", values = c("gain" = "green4", "loss" = "red")) +
    labs(title = "Portfolio Returns 3",
         x = "", y = "Monthly Returns") +
    geom_smooth(method = "lm") +
    theme_tq() +
    scale_color_tq() +
    scale_y_continuous(labels = scales::percent)
port_returns_3_plotly <- ggplotly(port_returns_3_plotly)
port_returns_3_plotly

```


In the following code chunk, we create a weights table. Here, we create 3 sets of weights for the selected 5 symbols (4 stocks + 1 benchmark index).

When designing the shiny app, users will be able to set the various weights for the 3 different portfolios.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Creating a weights table"}
weights <- c(
    0.25, 0.25, 0.25, 0.25, 0.00,
    0.40, 0.30, 0.20, 0.10, 0.00, 
    0.20, 0.20, 0.20, 0.20, 0.20
)

weights_table <-  tibble(portfolio_ticker_selection) %>%
    tq_repeat_df(n = 3) %>%
    bind_cols(tibble(weights)) %>%
    group_by(portfolio)
weights_table
```

In the following code chunk, we scale the single portfolio to 3, for subsequent multiple portfolio comparison analysis.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Scaling a single portfolio to 3"}
stock_returns_monthly_multi <- stock_returns_monthly %>%
    tq_repeat_df(n = 3)
head(stock_returns_monthly_multi)
```

In the following code chunk, we apply the weights table to the previously calculated monthly returns of the 3 portfolios. In addition, the initial investment capital is used along with the monthly returns to create the portfolio equity position every month.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Applying the weights table to calculate the various portfolios' monthly returns"}
portfolio_growth_monthly_multi <- stock_returns_monthly_multi %>%
    tq_portfolio(assets_col   = symbol, 
                 returns_col  = Ra, 
                 weights      = weights_table, 
                 col_rename   = "investment.growth",
                 wealth.index = TRUE) %>%
    mutate(investment.growth = investment.growth * initial_investment_capital)
portfolio_growth_monthly_multi
```

In the following code chunk, we create an equity curve comparing the performance of the 3 portfolios created.

```{r, echo=TRUE, eval=TRUE, out.width="100%", fig.cap="Creating an equity curve comparing the performance of the 3 portfolios"}
portfolio_plotly <- portfolio_growth_monthly_multi %>%
    ggplot(aes(x = date, y = investment.growth, color = factor(portfolio))) +
    geom_line(size = 1.5) + geom_point() +
    labs(title = "Portfolio Growth - Plotly",
         subtitle = "Comparing Multiple Portfolios",
         caption = "Which of the 3 portfolios is the best?",
         x = "", y = "Portfolio Value",
         color = "Portfolio") +
    geom_smooth(method = "loess") +
    theme_tq() +
    scale_color_tq() +
    scale_y_continuous(labels = scales::dollar)
portfolio_plotly <- ggplotly(portfolio_plotly)
portfolio_plotly
```




## 4. Conclusions and Insights


## 5. References

















